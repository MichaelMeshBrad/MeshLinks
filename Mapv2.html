<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Yorkshire Mesh – MeshCore Network Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://meshcorelinks.michaelholroyd.uk/meshcore_logo.png">
  <!-- Leaflet + MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    :root{
      --bg:#0b0f1a;      /* similar dark background used across the links site */
      --panel:#121a2b;   /* card background */
      --panel-2:#0f1626; /* darker edge */
      --text:#e8eef7;
      --muted:#a4b1c7;
      --accent:#6fd1ff;
      --border:#213054;
      --link:#8ad8ff;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 10% -10%, #15203a 0%, transparent 60%),
                  radial-gradient(1200px 600px at 90% -10%, #111a31 0%, transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    a{ color:var(--link); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:20px 16px 0;
    }
    /* Header bar to match existing pages */
    .brand{
      display:flex; align-items:center; gap:14px;
      padding:10px 12px;
    }
    .brand img{ height:34px; width:auto; filter: drop-shadow(0 0 12px rgba(111,209,255,.15)); }
    .brand h1{
      margin:0;
      font-size: clamp(18px, 2.8vw, 26px);
      letter-spacing:.2px;
    }
    .subhead{
      color:var(--muted);
      font-size:14px;
      margin-top:4px;
    }
    .nav{
      margin-top:10px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .nav a, .chip{
      background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border:1px solid var(--border);
      padding:7px 10px;
      border-radius:8px;
      font-size:13px;
      color:var(--text);
      display:inline-flex; gap:8px; align-items:center;
      text-decoration:none;
    }
    .chip input{ margin:0; }
    .panel{
      margin:14px 0 0;
      border:1px solid var(--border);
      background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border-radius:14px;
      overflow:hidden;
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
    }
    .panel-head{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:space-between;
    }
    .controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .controls > *{
      background:rgba(255,255,255,.02);
      border:1px solid var(--border);
      color:var(--text);
      border-radius:10px;
      padding:8px 10px;
      font-size:13px;
    }
    #search{ width:min(360px,70vw); }
    .badge{
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
      color:var(--muted);
      padding:6px 10px; border-radius:10px; font-size:12px;
    }
    .tabs{
      display:flex; gap:6px; align-items:center; flex-wrap:wrap;
    }
    .tab{
      padding:8px 12px; border:1px solid var(--border);
      border-radius:10px; background:rgba(255,255,255,.02);
      cursor:pointer; font-weight:600; font-size:13px;
    }
    .tab.active{ outline:2px solid var(--accent); }
    /* Map + table areas */
    #map{ height: 75vh; min-height:440px; }
    .legend {
      position:absolute; z-index:1000; bottom:16px; right:16px;
      background:rgba(0,0,0,.5);
      padding:10px 12px; border-radius:10px;
      border:1px solid var(--border); color:var(--text); font-size:12px;
    }
    .dot{ display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; vertical-align:middle; }
    .dot-repeater{ background:#0c7; }
    .dot-node{ background:#58e; }
    .popup{ font-size:13px; }
    footer{
      text-align:center; color:var(--muted); font-size:12px;
      padding:12px 8px 30px;
    }
    /* Table styling to mirror card look */
    .table-wrap{ overflow:auto; max-height:60vh; }
    table{ width:100%; border-collapse:collapse; color:var(--text); }
    thead th{ position:sticky; top:0; background:#0f1830; padding:10px; text-align:left; font-size:13px; border-bottom:1px solid var(--border); cursor:pointer; }
    tbody td{ padding:10px; border-bottom:1px solid var(--border); font-size:13px; }
    tbody tr{ transition: background .15s; }
    tbody tr:hover{ background:#0f1830; }
    .right{ text-align:right; }
    .nowrap{ white-space:nowrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <img src="https://meshcorelinks.michaelholroyd.uk/meshcore_logo.png" alt="MeshCore Logo">
      <div>
        <h1>Yorkshire Mesh – MeshCore Network</h1>
        <div class="subhead">Part of the <a href="https://meshcore.dev" target="_blank" rel="noopener">MeshCore</a> project – Secure, off‑grid messaging for Yorkshire communities.</div>
        <div class="nav">
          <a href="https://meshcorelinks.michaelholroyd.uk/" target="_blank" rel="noopener">← Project Links</a>
          <a href="https://meshcorelinks.michaelholroyd.uk/YM-Map.html" target="_blank" rel="noopener">Legacy YM‑Map</a>
          <a href="https://meshcore.co.uk/" target="_blank" rel="noopener">MeshCore Official</a>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-head">
        <div class="tabs">
          <div class="tab active" data-tab="map">Map</div>
          <div class="tab" data-tab="list">Repeaters</div>
        </div>
        <div class="controls">
          <label class="chip"><input type="checkbox" id="showRepeatersOnly"> Show repeaters only</label>
          <label class="chip"><input type="checkbox" id="hideStale"> Hide stale (&gt;24h)</label>
          <label class="chip"><input type="checkbox" id="showCoverage"> Coverage</label>
          <select id="coverageKm" title="Coverage radius (km)">
            <option value="10">10 km</option>
            <option value="5">5 km</option>
            <option value="15">15 km</option>
            <option value="20">20 km</option>
          </select>
          <select id="regionPreset" title="Quick zoom">
            <option value="yorkshire">Yorkshire (default)</option>
            <option value="leeds">Leeds</option>
            <option value="bradford">Bradford</option>
            <option value="sheffield">Sheffield</option>
            <option value="hull">Hull</option>
            <option value="whole">Whole UK</option>
          </select>
          <input id="search" type="text" placeholder="Search (name, callsign, ID, description)…" />
          <span class="badge" id="lastUpdated">Last update: —</span>
        </div>
      </div>

      <section id="mapWrap" style="position:relative; display:block;">
        <div id="map"></div>
        <div class="legend">
          <div><span class="dot dot-repeater"></span>Repeater/Relay</div>
          <div><span class="dot dot-node"></span>Node</div>
        </div>
      </section>

      <section id="listWrap" style="display:none; padding:12px;">
        <div class="badge" id="repeaterCount">0 repeaters</div>
        <div class="badge" id="filteredCount" style="margin-left:8px;">0 shown</div>
        <div class="table-wrap" style="margin-top:10px;">
          <table id="repTable">
            <thead>
              <tr>
                <th data-key="name">Name</th>
                <th data-key="callsign">Callsign</th>
                <th data-key="lastSeen" class="nowrap">Last seen</th>
                <th data-key="age" class="right nowrap">Age (h)</th>
                <th data-key="battery" class="right">Battery %</th>
                <th data-key="channel">Channel</th>
                <th data-key="firmware">Firmware</th>
                <th data-key="lat" class="right">Lat</th>
                <th data-key="lng" class="right">Lon</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>

    <footer>
      Data source: meshcore.dev/api/v1/nodes • Auto‑refresh every 60s
    </footer>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    // Map setup & bounds
    const map = L.map('map', { worldCopyJump: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);
    const boundsPresets = {
      yorkshire: [[53.2, -2.2], [54.6, -0.5]],
      leeds: [[53.72, -1.70], [53.82, -1.40]],
      bradford: [[53.73, -1.90], [53.85, -1.65]],
      sheffield: [[53.30, -1.70], [53.45, -1.30]],
      hull: [[53.70, -0.45], [53.85, -0.20]],
      whole: [[49.8, -7.8], [59.0, 1.8]]
    };
    map.fitBounds(boundsPresets.yorkshire);

    const cluster = L.markerClusterGroup({ showCoverageOnHover:false, maxClusterRadius: 50 });
    const coverageLayer = L.layerGroup();
    map.addLayer(cluster);
    map.addLayer(coverageLayer);

    const state = {
      nodes: [],
      markers: [],
      markerById: new Map(),
      timer: null,
      sort: { key:'age', dir:'asc' }
    };

    const showRepeatersOnly = document.getElementById('showRepeatersOnly');
    const hideStale = document.getElementById('hideStale');
    const showCoverage = document.getElementById('showCoverage');
    const coverageKm = document.getElementById('coverageKm');
    const lastUpdated = document.getElementById('lastUpdated');
    const regionPreset = document.getElementById('regionPreset');
    const searchBox = document.getElementById('search');
    const tabBtns = Array.from(document.querySelectorAll('.tab'));
    const mapWrap = document.getElementById('mapWrap');
    const listWrap = document.getElementById('listWrap');
    const repTable = document.getElementById('repTable');
    const repTbody = repTable.querySelector('tbody');
    const repeaterCount = document.getElementById('repeaterCount');
    const filteredCount = document.getElementById('filteredCount');

    // Tabs
    tabBtns.forEach(btn => btn.addEventListener('click', () => {
      tabBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      if (tab === 'map') {
        listWrap.style.display = 'none';
        mapWrap.style.display = 'block';
        map.invalidateSize();
      } else {
        mapWrap.style.display = 'none';
        listWrap.style.display = 'block';
        renderList();
      }
    }));

    regionPreset.addEventListener('change', () => {
      map.fitBounds(boundsPresets[regionPreset.value] || boundsPresets.yorkshire);
    });

    showRepeatersOnly.addEventListener('change', renderAll);
    hideStale.addEventListener('change', renderAll);
    showCoverage.addEventListener('change', renderCoverage);
    coverageKm.addEventListener('change', renderCoverage);

    let searchTimer = null;
    searchBox.addEventListener('input', () => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(renderAll, 150);
    });

    repTable.querySelectorAll('thead th').forEach(th => {
      th.addEventListener('click', () => {
        const key = th.dataset.key;
        if (!key) return;
        if (state.sort.key === key) state.sort.dir = state.sort.dir === 'asc' ? 'desc' : 'asc';
        else { state.sort.key = key; state.sort.dir = key === 'name' ? 'asc' : 'asc'; }
        renderList();
      });
    });

    const API = 'https://meshcore.dev/api/v1/nodes';
    async function fetchNodes(){
      const res = await fetch(API, { cache: 'no-store' });
      if(!res.ok) throw new Error('Failed to fetch nodes');
      return res.json();
    }

    function isRepeater(n){ return !!(n.is_repeater || n.isRelay || n.flags?.includes?.('repeater') || n.role === 'repeater' || n.role === 'relay'); }
    function nodeLat(n){ return n.lat ?? n.latitude ?? n.location?.lat ?? n.coords?.lat; }
    function nodeLng(n){ return n.lng ?? n.lon ?? n.longitude ?? n.location?.lng ?? n.location?.lon ?? n.coords?.lng ?? n.coords?.lon; }
    function nodeName(n){ return (n.name || n.node_name || n.short_name || n.id || '').toString(); }
    function nodeCall(n){ return (n.callsign || '').toString(); }
    function nodeFirm(n){ return (n.firmware || n.fw || n.version || '').toString(); }
    function nodeBatt(n){ const b = (n.battery ?? n.battery_pct ?? n.power?.battery); return (b === undefined || b === null) ? '' : String(b); }
    function nodeChan(n){ return (n.channel || n.ch || n.settings?.channel || '').toString(); }
    function inYorkshireApprox(lat,lng){ return lat >= 53.2 && lat <= 54.6 && lng >= -2.2 && lng <= -0.5; }

    function lastSeenAgeHours(n){
      const t = n.last_seen || n.lastSeen || n.last_seen_at;
      if(!t) return Infinity;
      const ts = new Date(t).getTime();
      if(Number.isNaN(ts)) return Infinity;
      return (Date.now() - ts) / 36e5;
    }
    function lastSeenNice(n){
      const t = n.last_seen || n.lastSeen || n.last_seen_at;
      if(!t) return '—';
      const d = new Date(t); if(isNaN(d)) return '—';
      const diff = Date.now() - d.getTime();
      const mins = Math.floor(diff/60000);
      if(mins < 1) return 'just now';
      if(mins < 60) return `${mins} min ago`;
      const h = Math.floor(mins/60);
      if(h < 24) return `${h} h ago`;
      const days = Math.floor(h/24);
      return `${days} d ago`;
    }

    function matchesSearch(n, q){
      if(!q) return true;
      q = q.toLowerCase();
      return (
        nodeName(n).toLowerCase().includes(q) ||
        nodeCall(n).toLowerCase().includes(q) ||
        (n.id && String(n.id).toLowerCase().includes(q)) ||
        (n.description && n.description.toLowerCase().includes(q))
      );
    }

    function filteredNodes(){
      const onlyRepeaters = showRepeatersOnly.checked;
      const hideOld = hideStale.checked;
      const q = searchBox.value.trim();
      const region = regionPreset.value;
      return state.nodes.filter(n => {
        const lat = Number(nodeLat(n)), lng = Number(nodeLng(n));
        if(!Number.isFinite(lat) || !Number.isFinite(lng)) return false;
        if(region !== 'whole' && !inYorkshireApprox(lat,lng)) return false;
        if(onlyRepeaters && !isRepeater(n)) return false;
        if(hideOld && lastSeenAgeHours(n) > 24) return false;
        if(!matchesSearch(n, q)) return false;
        return true;
      });
    }

    function popupHtml(n){
      const name = nodeName(n) || 'Unnamed node';
      const fw = nodeFirm(n);
      const bat = nodeBatt(n);
      const ch = nodeChan(n);
      const ls = n.last_seen || n.lastSeen || n.last_seen_at;
      return `
        <div class="popup">
          <strong>${name}</strong> ${isRepeater(n) ? ' <span class="badge">Repeater</span>' : ''}
          <div>${n.description ? n.description : ''}</div>
          <hr>
          <div><b>Last seen:</b> ${ls ? new Date(ls).toLocaleString() : '—'} (${lastSeenNice(n)})</div>
          <div><b>Battery:</b> ${bat !== '' ? bat + '%' : '—'}</div>
          <div><b>Channel:</b> ${ch || '—'}</div>
          <div><b>Firmware:</b> ${fw || '—'}</div>
          ${nodeCall(n) ? `<div><b>Callsign:</b> ${nodeCall(n)}</div>` : ''}
          ${n.id ? `<div><b>Node ID:</b> ${n.id}</div>` : ''}
        </div>`;
    }

    function markerIcon(n){
      const repeater = isRepeater(n);
      const color = repeater ? '#0c7' : '#58e';
      return L.divIcon({
        html:`<div style="width:14px;height:14px;border-radius:50%;background:${color};box-shadow:0 0 0 2px #0b1220, 0 0 8px ${color}80"></div>`,
        className: repeater ? 'dot-repeater' : 'dot-node',
        iconSize:[14,14]
      });
    }

    function renderMap(){
      cluster.clearLayers();
      coverageLayer.clearLayers();
      state.markerById.clear();
      state.markers = [];
      const nodes = filteredNodes();
      for(const n of nodes){
        const lat = Number(nodeLat(n)), lng = Number(nodeLng(n));
        const m = L.marker([lat,lng], { icon: markerIcon(n) }).bindPopup(popupHtml(n));
        state.markers.push(m);
        state.markerById.set(n.id ?? nodeName(n), m);
      }
      cluster.addLayers(state.markers);
      renderCoverage();
    }

    function renderCoverage(){
      coverageLayer.clearLayers();
      if(!showCoverage.checked) return;
      const km = Number(coverageKm.value) || 10;
      const nodes = filteredNodes().filter(isRepeater);
      for(const n of nodes){
        const lat = Number(nodeLat(n)), lng = Number(nodeLng(n));
        if(!Number.isFinite(lat) || !Number.isFinite(lng)) continue;
        L.circle([lat,lng], { radius: km*1000, weight:1, opacity:.9, fillOpacity:.08 }).addTo(coverageLayer);
      }
    }

    function renderList(){
      let rows = filteredNodes().filter(isRepeater).map(n => {
        const lat = Number(nodeLat(n)), lng = Number(nodeLng(n));
        return {
          raw:n,
          name: nodeName(n) || '—',
          callsign: nodeCall(n) || '—',
          lastSeen: lastSeenNice(n),
          age: +lastSeenAgeHours(n).toFixed(1),
          battery: nodeBatt(n) || '',
          channel: nodeChan(n) || '—',
          firmware: nodeFirm(n) || '—',
          lat: Number.isFinite(lat) ? lat.toFixed(5) : '',
          lng: Number.isFinite(lng) ? lng.toFixed(5) : ''
        };
      });

      const { key, dir } = state.sort;
      rows.sort((a,b) => {
        const va=a[key], vb=b[key];
        if (key==='age'||key==='battery'||key==='lat'||key==='lng'){
          const na=Number(va||0), nb=Number(vb||0);
          return dir==='asc'? na-nb : nb-na;
        }
        const sa=String(va||'').toLowerCase(), sb=String(vb||'').toLowerCase();
        return dir==='asc' ? (sa>sb?1:sa<sb?-1:0) : (sa<sb?1:sa>sb?-1:0);
      });

      const allRepeaters = state.nodes.filter(isRepeater).length;
      repeaterCount.textContent = `${allRepeaters} repeaters total`;
      filteredCount.textContent = `${rows.length} shown`;

      repTbody.innerHTML='';
      for(const r of rows){
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(r.name)}</td>
          <td>${escapeHtml(r.callsign)}</td>
          <td class="nowrap">${escapeHtml(r.lastSeen)}</td>
          <td class="right nowrap">${Number.isFinite(r.age)? r.age : '—'}</td>
          <td class="right">${r.battery!==''? r.battery : '—'}</td>
          <td>${escapeHtml(r.channel)}</td>
          <td>${escapeHtml(r.firmware)}</td>
          <td class="right">${r.lat}</td>
          <td class="right">${r.lng}</td>`;
        tr.style.cursor='pointer';
        tr.title='Show on map';
        tr.addEventListener('click', () => {
          tabBtns.forEach(b => b.classList.remove('active'));
          document.querySelector('.tab[data-tab="map"]').classList.add('active');
          listWrap.style.display='none'; mapWrap.style.display='block'; map.invalidateSize();
          const idKey = r.raw.id ?? r.name;
          const m = state.markerById.get(idKey);
          const lat = Number(nodeLat(r.raw)), lng = Number(nodeLng(r.raw));
          map.setView([lat,lng], 14);
          if(m) m.openPopup();
        });
        repTbody.appendChild(tr);
      }
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',\"'\":'&#39;'}[c]));
    }

    function renderAll(){
      renderMap();
      if (listWrap.style.display !== 'none') renderList();
      lastUpdated.textContent = 'Last update: ' + new Date().toLocaleTimeString();
    }

    async function refresh(){
      try {
        const data = await fetchNodes();
        state.nodes = Array.isArray(data) ? data : (data.nodes || data.items || []);
        renderAll();
      } catch(e){
        lastUpdated.textContent = 'Last update: error';
        console.error(e);
      }
    }

    refresh();
    state.timer = setInterval(refresh, 60000);
  </script>
</body>
</html>
