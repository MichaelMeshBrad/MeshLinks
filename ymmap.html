<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Yorkshire Mesh – MeshCore Network Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://meshcorelinks.michaelholroyd.uk/meshcore_logo.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    :root{ --bg:#0b0f1a; --panel:#121a2b; --panel-2:#0f1626; --text:#e8eef7; --muted:#a4b1c7; --accent:#6fd1ff; --border:#213054; --link:#8ad8ff; --error:#ff6b6b; }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 10% -10%, #15203a 0%, transparent 60%),
                  radial-gradient(1200px 600px at 90% -10%, #111a31 0%, transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    a{ color:var(--link); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    .wrap{ max-width:1100px; margin:0 auto; padding:20px 16px 0; }
    .brand{ display:flex; align-items:center; gap:14px; padding:10px 12px; }
    .brand img{ height:34px; width:auto; filter: drop-shadow(0 0 12px rgba(111,209,255,.15)); }
    .brand h1{ margin:0; font-size: clamp(18px, 2.8vw, 26px); letter-spacing:.2px; }
    .subhead{ color:var(--muted); font-size:14px; margin-top:4px; }
    .nav{ margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; }
    .nav a, .chip{ background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border:1px solid var(--border); padding:7px 10px; border-radius:8px; font-size:13px; color:var(--text); display:inline-flex; gap:8px; align-items:center; text-decoration:none; }
    .chip input{ margin:0; }
    .panel{ margin:14px 0 0; border:1px solid var(--border); background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%); border-radius:14px; overflow:hidden; box-shadow: 0 8px 20px rgba(0,0,0,.25); }
    .panel-head{ padding:12px 14px; border-bottom:1px solid var(--border); display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:space-between; }
    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .controls > *{ background:rgba(255,255,255,.02); border:1px solid var(--border); color:var(--text); border-radius:10px; padding:8px 10px; font-size:13px; }
    #search{ width:min(360px,70vw); }
    .badge{ border:1px solid var(--border); background:rgba(255,255,255,.02); color:var(--muted); padding:6px 10px; border-radius:10px; font-size:12px; }
    .tabs{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .tab{ padding:8px 12px; border:1px solid var(--border); border-radius:10px; background:rgba(255,255,255,.02); cursor:pointer; font-weight:600; font-size:13px; }
    .tab.active{ outline:2px solid var(--accent); }
    #map{ height: 75vh; min-height:440px; }
    .legend { position:absolute; z-index:1000; bottom:16px; right:16px; background:rgba(0,0,0,.5); padding:10px 12px; border-radius:10px; border:1px solid var(--border); color:var(--text); font-size:12px; }
    .dot{ display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; vertical-align:middle; }
    .dot-repeater{ background:#0c7; } .dot-node{ background:#58e; }
    .popup{ font-size:13px; }
    footer{ text-align:center; color:var(--muted); font-size:12px; padding:12px 8px 30px; }
    .error{ display:none; margin:10px; border:1px solid rgba(255,107,107,.4); background:rgba(255,107,107,.08); color:var(--error); padding:8px 10px; border-radius:10px; font-size:13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <img src="https://meshcorelinks.michaelholroyd.uk/meshcore_logo.png" alt="MeshCore Logo">
      <div>
        <h1>Yorkshire Mesh – MeshCore Network</h1>
        <div class="subhead">Live view of active nodes & repeaters across Yorkshire</div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-head">
        <div class="tabs">
          <div class="tab active" data-tab="map">Map</div>
          <div class="tab" data-tab="list">Repeaters</div>
        </div>
        <div class="controls">
          <label class="chip"><input type="checkbox" id="showRepeatersOnly"> Show repeaters only</label>
          <label class="chip"><input type="checkbox" id="hideStale"> Hide stale (&gt;24h)</label>
          <label class="chip"><input type="checkbox" id="showCoverage"> Coverage</label>
          <select id="coverageKm"><option value="10">10 km</option><option value="5">5 km</option></select>
          <input id="search" type="text" placeholder="Search…" />
          <span class="badge" id="lastUpdated">Last update: —</span>
        </div>
      </div>

      <div class="error" id="errBox"></div>

      <section id="mapWrap" style="position:relative; display:block;">
        <div id="map"></div>
        <div class="legend">
          <div><span class="dot dot-repeater"></span>Repeater/Relay</div>
          <div><span class="dot dot-node"></span>Node</div>
        </div>
      </section>

      <section id="listWrap" style="display:none; padding:12px;">
        <div class="badge" id="repeaterCount">0 repeaters</div>
        <div class="badge" id="filteredCount" style="margin-left:8px;">0 shown</div>
        <table id="repTable">
          <thead><tr><th>Name</th><th>Callsign</th><th>Last seen</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>
    </div>

    <footer>Data source: meshcore.dev/api/v1/nodes • Auto-refresh every 60s</footer>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    // Initialise map immediately
    const map = L.map('map').setView([53.8, -1.75], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
    const cluster = L.markerClusterGroup(); map.addLayer(cluster);

    const errBox = document.getElementById('errBox');
    const lastUpdated = document.getElementById('lastUpdated');
    const repeaterCount = document.getElementById('repeaterCount');
    const filteredCount = document.getElementById('filteredCount');
    const repTbody = document.querySelector('#repTable tbody');

    const API = 'https://meshcore.dev/api/v1/nodes';

    async function loadData() {
      try {
        const res = await fetch(API, { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        const nodes = Array.isArray(data) ? data : (data.nodes || []);
        renderNodes(nodes);
        errBox.style.display = 'none';
      } catch (e) {
        console.error(e);
        errBox.style.display = 'block';
        errBox.textContent = 'Failed to load data: ' + e;
      }
      lastUpdated.textContent = 'Last update: ' + new Date().toLocaleTimeString();
    }

    function renderNodes(nodes) {
      cluster.clearLayers();
      repTbody.innerHTML = '';
      let repCount = 0;
      nodes.forEach(n => {
        const lat = n.lat || n.latitude || n.location?.lat;
        const lng = n.lng || n.lon || n.longitude || n.location?.lng;
        if (!lat || !lng) return;
        const marker = L.marker([lat, lng]);
        marker.bindPopup('<b>' + (n.name || 'Unnamed') + '</b>');
        cluster.addLayer(marker);
        if (n.is_repeater) repCount++;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${n.name || '—'}</td><td>${n.callsign || '—'}</td><td>${n.last_seen || '—'}</td>`;
        repTbody.appendChild(tr);
      });
      repeaterCount.textContent = repCount + ' repeaters';
      filteredCount.textContent = nodes.length + ' shown';
    }

    loadData();
    setInterval(loadData, 60000);
  </script>
</body>
</html>
